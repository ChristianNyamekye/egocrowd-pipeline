<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mission Control — ClawD HQ</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0c14;--panel:#161822;--border:#252836;
  --text:#e0e0e0;--dim:#7a7f8e;
  --blue:#4ea8de;--green:#6bcf7f;--orange:#f0a05a;--purple:#b47ede;--red:#e85d5d;
}
html,body{height:100vh;overflow:hidden;background:var(--bg);color:var(--text);font-family:'Inter',sans-serif}

/* ─── MAIN LAYOUT ─── */
.main{display:flex;flex-direction:column;height:100vh}
.scene-section{position:relative;flex:0 0 45%;overflow:hidden;background:#0a0c14}
.timeline-section{flex:1;display:flex;flex-direction:column;background:var(--bg);border-top:1px solid rgba(255,255,255,.08);overflow:hidden}

/* ─── OFFICE SCENE ─── */
.office-bg{width:100%;height:100%;object-fit:cover;display:block;filter:brightness(.85) saturate(1.1)}

/* ─── CHARACTERS ─── */
.character{
  position:absolute;cursor:pointer;transition:transform .3s ease;z-index:10;
  filter:drop-shadow(0 4px 12px rgba(0,0,0,.5));
}
.character img{width:100%;height:100%;object-fit:contain;pointer-events:none}
.character:hover{transform:scale(1.08)!important;z-index:20}
.character:hover .nametag{opacity:1;text-shadow:0 0 10px currentColor}

.nametag{
  position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);
  font-size:10px;font-weight:600;font-family:'Space Grotesk',sans-serif;
  color:var(--blue);white-space:nowrap;opacity:.8;transition:all .3s;
  text-shadow:0 0 6px rgba(78,168,222,.4);letter-spacing:1px;text-transform:uppercase;
}
#char-jarvis{left:8%;top:28%;width:110px;height:110px}
#char-research{left:28%;top:32%;width:100px;height:100px}
#char-builder{left:50%;top:26%;width:105px;height:105px}
#char-outreach{left:70%;top:30%;width:100px;height:100px}
#char-scanner{left:88%;top:34%;width:95px;height:95px}

@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
@keyframes workBounce{0%,100%{transform:translateY(0)}25%{transform:translateY(-3px)}75%{transform:translateY(1px)}}
.char-idle{animation:bob 3s ease-in-out infinite}
.char-working{animation:workBounce 1.2s ease-in-out infinite}

/* ─── SPEECH BUBBLE ─── */
.speech-bubble{
  position:absolute;top:-38px;left:50%;transform:translateX(-50%);
  background:rgba(22,24,34,.92);border:1px solid rgba(255,255,255,.12);
  border-radius:8px;padding:4px 10px;font-size:9px;color:var(--text);
  white-space:nowrap;opacity:0;transition:opacity .4s;pointer-events:none;
  backdrop-filter:blur(8px);font-family:'Space Grotesk',sans-serif;
  box-shadow:0 2px 12px rgba(0,0,0,.4);
}
.speech-bubble::after{
  content:'';position:absolute;bottom:-5px;left:50%;transform:translateX(-50%);
  border-left:5px solid transparent;border-right:5px solid transparent;
  border-top:5px solid rgba(22,24,34,.92);
}
.character:hover .speech-bubble,.speech-bubble.visible{opacity:1}

/* ─── TASK HANDOFF ─── */
.handoff-doc{
  position:absolute;width:16px;height:20px;
  background:linear-gradient(135deg,#f0a05a,#f7c948);
  border-radius:2px;opacity:0;z-index:25;pointer-events:none;
  box-shadow:0 0 12px rgba(247,201,72,.6);
}

/* ─── CHARACTER DETAIL MODAL ─── */
.char-modal{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);
  background:rgba(22,24,34,.95);backdrop-filter:blur(20px);
  border:1px solid rgba(255,255,255,.1);border-radius:16px;
  padding:24px;min-width:280px;z-index:100;opacity:0;pointer-events:none;
  transition:all .3s ease;box-shadow:0 20px 60px rgba(0,0,0,.6);
}
.char-modal.open{opacity:1;pointer-events:auto;transform:translate(-50%,-50%) scale(1)}
.char-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:99;opacity:0;pointer-events:none;transition:opacity .3s}
.char-modal-overlay.open{opacity:1;pointer-events:auto}
.modal-header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.modal-avatar{width:48px;height:48px;border-radius:12px;object-fit:contain;background:rgba(255,255,255,.05);padding:4px}
.modal-name{font-family:'Space Grotesk',sans-serif;font-size:18px;font-weight:700}
.modal-status{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.modal-status.working{background:rgba(78,168,222,.2);color:var(--blue)}
.modal-status.idle{background:rgba(107,207,127,.2);color:var(--green)}
.modal-task{font-size:12px;color:var(--dim);margin-bottom:10px}
.modal-task span{color:var(--text);font-weight:500}
.modal-completed{font-size:11px;color:var(--dim)}
.modal-completed li{margin:3px 0;list-style:none}
.modal-completed li::before{content:'✓ ';color:var(--green)}
.modal-close{position:absolute;top:12px;right:14px;background:none;border:none;color:var(--dim);cursor:pointer;font-size:16px}

/* ─── TOP INFO BAR ─── */
.scene-topbar{
  position:absolute;top:0;left:0;right:0;
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 20px;z-index:30;
  background:linear-gradient(180deg,rgba(10,12,20,.85) 0%,transparent 100%);
}
.scene-topbar h1{font-size:12px;letter-spacing:2.5px;text-transform:uppercase;color:var(--blue);font-weight:600;font-family:'Space Grotesk',sans-serif}
.scene-topbar h1 span{color:var(--dim);font-weight:400}
.clock{font-family:'Space Grotesk',monospace;font-size:11px;color:var(--dim)}
.clock .time{color:var(--blue);font-size:13px;font-weight:600}

/* ─── HEARTBEAT FEED OVERLAY ─── */
.heartbeat-feed{
  position:absolute;bottom:12px;left:12px;z-index:30;
  width:340px;
  background:rgba(8,10,18,.82);
  backdrop-filter:blur(14px);
  border:1px solid rgba(107,207,127,.15);
  border-radius:10px;
  padding:10px 12px;
  font-family:'JetBrains Mono',monospace;
}
.hb-title{
  display:flex;align-items:center;gap:6px;
  font-size:9px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--green);margin-bottom:8px;
}
@keyframes hbPulse{0%,100%{opacity:1;box-shadow:0 0 4px rgba(107,207,127,.6)}50%{opacity:.4;box-shadow:0 0 8px rgba(107,207,127,.2)}}
.hb-dot{
  width:6px;height:6px;border-radius:50%;background:var(--green);
  animation:hbPulse 2s ease-in-out infinite;
}
.hb-time{margin-left:auto;font-size:8px;color:var(--dim);font-weight:400;letter-spacing:0}
.hb-items{display:flex;flex-direction:column;gap:4px}
.hb-item{
  font-size:10px;line-height:1.4;color:rgba(107,207,127,.55);
  display:flex;align-items:flex-start;gap:6px;
}
.hb-item.active{color:rgba(107,207,127,.95);text-shadow:0 0 8px rgba(107,207,127,.3)}
.hb-item .hb-marker{flex-shrink:0;margin-top:3px;width:4px;height:4px;border-radius:50%;background:currentColor}
.hb-item.active .hb-marker{box-shadow:0 0 6px rgba(107,207,127,.6)}
.hb-empty{font-size:10px;color:rgba(107,207,127,.4);font-style:italic}

/* ─── TIMELINE SECTION ─── */
.tl-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 20px;flex-shrink:0;
}
.tl-header h2{font-family:'Space Grotesk',sans-serif;font-size:12px;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim)}
.tl-stats{display:flex;gap:14px;font-size:10px;color:var(--dim)}
.tl-stats .s{display:flex;align-items:center;gap:4px}
.tl-stats .s .n{font-weight:700;font-size:13px}
.tl-stats .s.done .n{color:var(--green)}
.tl-stats .s.wip .n{color:var(--blue)}
.tl-stats .s.queue .n{color:var(--orange)}
.tl-stats .s.learn .n{color:var(--purple)}

/* Timeline container */
.tl-container{flex:1;display:flex;flex-direction:column;padding:0 20px 10px;min-height:0;overflow:hidden}

/* Pipeline */
.pipeline{position:relative;display:flex;align-items:stretch;flex:1;min-height:0;gap:0}

/* Pipeline zones */
.tl-zone{
  display:flex;flex-direction:column;border-radius:10px;padding:8px 10px;
  position:relative;overflow:hidden;
}
.tl-zone-completed{flex:2;background:rgba(107,207,127,.04);border:1px solid rgba(107,207,127,.1)}
.tl-zone-wip{flex:1;background:rgba(78,168,222,.04);border:1px solid rgba(78,168,222,.15);margin:0 8px}
.tl-zone-next{flex:0.6;background:rgba(240,160,90,.03);border:1px solid rgba(240,160,90,.08)}

@keyframes wipBorder{0%,100%{border-color:rgba(78,168,222,.15)}50%{border-color:rgba(78,168,222,.35)}}
.tl-zone-wip{animation:wipBorder 3s ease-in-out infinite}

.tl-zone-label{
  font-family:'Space Grotesk',sans-serif;font-size:9px;font-weight:600;
  letter-spacing:1.2px;text-transform:uppercase;margin-bottom:6px;
  display:flex;align-items:center;gap:6px;flex-shrink:0;
}
.tl-zone-completed .tl-zone-label{color:var(--green)}
.tl-zone-wip .tl-zone-label{color:var(--blue)}
.tl-zone-next .tl-zone-label{color:var(--orange)}

.tl-zone-items{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:2px;min-height:0}
.tl-zone-items::-webkit-scrollbar{width:3px}
.tl-zone-items::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}

.tl-item{
  font-size:10px;color:var(--dim);padding:3px 6px;border-radius:4px;
  display:flex;align-items:flex-start;gap:5px;line-height:1.35;
  transition:background .2s;
}
.tl-item:hover{background:rgba(255,255,255,.04)}
.tl-item .tl-node{flex-shrink:0;margin-top:3px;width:6px;height:6px;border-radius:50%;transition:box-shadow .3s}
.tl-item:hover .tl-node{box-shadow:0 0 8px currentColor}

.tl-zone-completed .tl-node{background:var(--green);color:var(--green)}
.tl-zone-completed .tl-item{color:rgba(107,207,127,.7)}

.tl-zone-wip .tl-node{background:var(--blue);color:var(--blue);box-shadow:0 0 6px rgba(78,168,222,.4)}
.tl-zone-wip .tl-item{color:var(--text)}
@keyframes nodePulse{0%,100%{box-shadow:0 0 4px rgba(78,168,222,.4)}50%{box-shadow:0 0 10px rgba(78,168,222,.7)}}
.tl-zone-wip .tl-node{animation:nodePulse 2s ease-in-out infinite;width:7px;height:7px}

.tl-zone-next .tl-node{background:var(--orange);color:var(--orange);opacity:.5}
.tl-zone-next .tl-item{color:rgba(240,160,90,.5)}

/* Connectors between zones */
.tl-connector{
  display:flex;align-items:center;justify-content:center;width:20px;flex-shrink:0;
  position:relative;
}
.tl-connector::before{
  content:'';position:absolute;top:50%;width:100%;height:2px;
  background:linear-gradient(90deg,var(--green),var(--blue));
}
.tl-connector.c2::before{background:linear-gradient(90deg,var(--blue),var(--orange))}

/* Flowing particles on connectors */
@keyframes flowParticle{0%{left:-4px;opacity:0}20%{opacity:1}80%{opacity:1}100%{left:calc(100% + 4px);opacity:0}}
.tl-connector .particle{
  position:absolute;top:calc(50% - 2px);width:4px;height:4px;border-radius:50%;
  background:var(--blue);box-shadow:0 0 6px var(--blue);
  animation:flowParticle 2.5s linear infinite;
}
.tl-connector .particle:nth-child(2){animation-delay:1.2s}

/* Learned badges floating above timeline */
.tl-learned{
  display:flex;flex-wrap:wrap;gap:5px;padding:4px 0 6px;flex-shrink:0;
}
.tl-badge{
  font-size:9px;padding:2px 8px;border-radius:10px;
  background:rgba(180,126,222,.1);border:1px solid rgba(180,126,222,.2);
  color:var(--purple);font-family:'Space Grotesk',sans-serif;font-weight:500;
  transition:all .3s;
}
.tl-badge:hover{background:rgba(180,126,222,.2);box-shadow:0 0 8px rgba(180,126,222,.2)}

/* Pipeline flow line */
.pipeline-flow{
  position:absolute;bottom:0;left:0;right:0;height:2px;overflow:hidden;z-index:2;pointer-events:none;
}
@keyframes pipeFlow{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.pipeline-flow::after{
  content:'';position:absolute;top:0;left:0;width:50%;height:100%;
  background:linear-gradient(90deg,transparent,var(--green),var(--blue),var(--orange),transparent);
  animation:pipeFlow 4s linear infinite;
}

/* ─── DRAG AND DROP ─── */
.tl-item[draggable="true"]{cursor:grab}
.tl-item[draggable="true"]:active{cursor:grabbing;opacity:.7}
.tl-item.dragging{opacity:.3;transform:scale(.95)}
.tl-zone.drag-over{outline:2px dashed rgba(255,255,255,.2);outline-offset:-4px;background:rgba(255,255,255,.03)}

/* ─── AUDIT LOG ─── */
.audit-section{
  flex-shrink:0;border-top:1px solid rgba(255,255,255,.06);
  max-height:0;overflow:hidden;transition:max-height .4s ease;
}
.audit-section.open{max-height:200px}
.audit-toggle{
  display:flex;align-items:center;gap:6px;padding:6px 20px;cursor:pointer;
  font-family:'Space Grotesk',sans-serif;font-size:10px;letter-spacing:1px;
  text-transform:uppercase;color:var(--dim);user-select:none;
  border-top:1px solid rgba(255,255,255,.06);flex-shrink:0;
}
.audit-toggle:hover{color:var(--text)}
.audit-toggle .arrow{transition:transform .3s;display:inline-block}
.audit-toggle.open .arrow{transform:rotate(180deg)}
.audit-items{padding:4px 20px 10px;overflow-y:auto;max-height:180px}
.audit-items::-webkit-scrollbar{width:3px}
.audit-items::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}
.audit-entry{margin-bottom:8px;padding:6px 8px;border-radius:6px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.04)}
.audit-entry-time{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--blue);margin-bottom:3px}
.audit-entry-items{font-size:10px;color:var(--dim);line-height:1.4}
.audit-entry-items div{padding:1px 0}

/* ─── BOTTOM PANELS (Gateway + Skills + Approvals) ─── */
.bottom-panels{
  display:flex;gap:8px;padding:4px 20px 8px;flex-shrink:0;
  border-top:1px solid rgba(255,255,255,.06);
}
.bp{flex:1;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:8px 10px;min-width:0}
.bp-title{
  font-family:'Space Grotesk',sans-serif;font-size:9px;font-weight:600;
  letter-spacing:1.2px;text-transform:uppercase;margin-bottom:6px;
  display:flex;align-items:center;gap:6px;
}
.bp-title.gw{color:var(--green)}.bp-title.sk{color:var(--purple)}.bp-title.ap{color:var(--orange)}

/* Gateway */
.gw-row{display:flex;align-items:center;gap:6px;font-size:10px;margin:3px 0}
.gw-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.gw-dot.ok{background:var(--green);box-shadow:0 0 6px rgba(107,207,127,.5)}
.gw-dot.warn{background:var(--orange);box-shadow:0 0 6px rgba(240,160,90,.5)}
.gw-dot.err{background:var(--red);box-shadow:0 0 6px rgba(232,93,93,.5)}
.gw-label{color:var(--dim)}.gw-val{color:var(--text);font-weight:500}

/* Skills */
.sk-grid{display:flex;flex-wrap:wrap;gap:4px;max-height:80px;overflow-y:auto}
.sk-grid::-webkit-scrollbar{width:2px}
.sk-grid::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:2px}
.sk-chip{
  font-size:9px;padding:2px 7px;border-radius:8px;
  font-family:'Space Grotesk',sans-serif;font-weight:500;white-space:nowrap;
}
.sk-chip.ready{background:rgba(107,207,127,.1);border:1px solid rgba(107,207,127,.2);color:var(--green)}
.sk-chip.missing{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);color:var(--dim)}
.sk-summary{font-size:9px;color:var(--dim);margin-top:4px}

/* Approvals */
.ap-item{
  display:flex;align-items:center;gap:6px;font-size:10px;padding:4px 6px;
  border-radius:4px;margin:3px 0;background:rgba(240,160,90,.04);
  border:1px solid rgba(240,160,90,.1);
}
.ap-item .ap-text{flex:1;color:var(--text);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ap-item .ap-agent{font-size:9px;color:var(--orange);font-weight:500;flex-shrink:0}
.ap-btn{
  padding:2px 6px;border-radius:4px;border:none;font-size:9px;font-weight:600;
  cursor:pointer;font-family:'Space Grotesk',sans-serif;
}
.ap-btn.yes{background:rgba(107,207,127,.2);color:var(--green)}
.ap-btn.yes:hover{background:rgba(107,207,127,.35)}
.ap-btn.no{background:rgba(232,93,93,.15);color:var(--red)}
.ap-btn.no:hover{background:rgba(232,93,93,.3)}
.ap-empty{font-size:10px;color:var(--dim);font-style:italic;padding:4px 0}
</style>
</head>
<body>
<div class="main">
  <!-- OFFICE SCENE -->
  <div class="scene-section" id="scene">
    <img src="office-bg.png" class="office-bg" alt="Office">
    
    <div class="scene-topbar">
      <h1>Mission Control <span>— ClawD HQ</span></h1>
      <div class="clock"><span class="time" id="clock-time">--:--</span> EST</div>
    </div>

    <!-- Characters -->
    <div class="character char-working" id="char-jarvis" data-agent="0" onclick="showModal(0)">
      <div class="speech-bubble" id="bubble-0">Rebuilding Mission Control</div>
      <img src="characters/jarvis.webp" alt="Jarvis">
      <div class="nametag" style="color:#4ea8de">Jarvis</div>
    </div>
    <div class="character char-idle" id="char-research" data-agent="1" onclick="showModal(1)">
      <div class="speech-bubble" id="bubble-1">Buyer landscape report done</div>
      <img src="characters/research.webp" alt="Research">
      <div class="nametag" style="color:#6bcf7f">Research</div>
    </div>
    <div class="character char-working" id="char-builder" data-agent="2" onclick="showModal(2)">
      <div class="speech-bubble" id="bubble-2">Phone hand tracker</div>
      <img src="characters/builder.webp" alt="Builder">
      <div class="nametag" style="color:#f0a05a">Builder</div>
    </div>
    <div class="character char-working" id="char-outreach" data-agent="3" onclick="showModal(3)">
      <div class="speech-bubble" id="bubble-3">Exa company intel</div>
      <img src="characters/outreach.webp" alt="Outreach">
      <div class="nametag" style="color:#b47ede">Outreach</div>
    </div>
    <div class="character char-idle" id="char-scanner" data-agent="4" onclick="showModal(4)">
      <div class="speech-bubble" id="bubble-4">Next scan in 4h</div>
      <img src="characters/scanner.webp" alt="Scanner">
      <div class="nametag" style="color:#e85d5d">Scanner</div>
    </div>

    <div class="handoff-doc" id="handoff-doc"></div>

    <!-- Heartbeat Feed Overlay -->
    <div class="heartbeat-feed" id="hb-feed">
      <div class="hb-title">
        <span class="hb-dot"></span>
        Heartbeat Feed
        <span class="hb-time" id="hb-time"></span>
      </div>
      <div class="hb-items" id="hb-items">
        <div class="hb-empty">Waiting for heartbeat…</div>
      </div>
    </div>
  </div>

  <!-- TIMELINE SECTION -->
  <div class="timeline-section">
    <div class="tl-header">
      <h2>Pipeline</h2>
      <div class="tl-stats">
        <div class="s done"><span class="n" id="stat-done">0</span> done</div>
        <div class="s wip"><span class="n" id="stat-wip">0</span> active</div>
        <div class="s queue"><span class="n" id="stat-queue">0</span> queued</div>
        <div class="s learn"><span class="n" id="stat-learn">0</span> learned</div>
      </div>
    </div>
    <div class="tl-learned" id="tl-learned"></div>
    <div class="tl-container">
      <div class="pipeline" id="pipeline">
        <div class="tl-zone tl-zone-completed">
          <div class="tl-zone-label">✓ Completed <span style="font-weight:400;opacity:.5" id="z-count-done"></span></div>
          <div class="tl-zone-items" id="tl-done"></div>
        </div>
        <div class="tl-connector"><div class="particle"></div><div class="particle"></div></div>
        <div class="tl-zone tl-zone-wip">
          <div class="tl-zone-label">⟳ In Progress <span style="font-weight:400;opacity:.5" id="z-count-wip"></span></div>
          <div class="tl-zone-items" id="tl-wip"></div>
        </div>
        <div class="tl-connector c2"><div class="particle"></div><div class="particle"></div></div>
        <div class="tl-zone tl-zone-next">
          <div class="tl-zone-label">◦ Up Next <span style="font-weight:400;opacity:.5" id="z-count-next"></span></div>
          <div class="tl-zone-items" id="tl-next"></div>
        </div>
        <div class="pipeline-flow"></div>
      </div>
    </div>
    <!-- Bottom Panels: Gateway + Skills + Approvals -->
    <div class="bottom-panels">
      <div class="bp">
        <div class="bp-title gw"><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green)" id="gw-indicator"></span> Gateway</div>
        <div id="gw-content"><div class="gw-row"><span class="gw-label">Loading...</span></div></div>
      </div>
      <div class="bp">
        <div class="bp-title sk">◆ Skills</div>
        <div class="sk-grid" id="sk-grid"></div>
        <div class="sk-summary" id="sk-summary"></div>
      </div>
      <div class="bp">
        <div class="bp-title ap">⚡ Approvals</div>
        <div id="ap-content"><div class="ap-empty">No pending approvals</div></div>
      </div>
    </div>

    <!-- Audit Log Toggle + Panel -->
    <div class="audit-toggle" id="audit-toggle" onclick="toggleAudit()">
      <span class="arrow">▼</span> Activity Audit Log
    </div>
    <div class="audit-section" id="audit-section">
      <div class="audit-items" id="audit-items"></div>
    </div>
  </div>
</div>

<!-- Character Detail Modal -->
<div class="char-modal-overlay" id="modal-overlay" onclick="closeModal()"></div>
<div class="char-modal" id="char-modal">
  <button class="modal-close" onclick="closeModal()">✕</button>
  <div class="modal-header">
    <img class="modal-avatar" id="modal-avatar" src="" alt="">
    <div>
      <div class="modal-name" id="modal-name"></div>
      <span class="modal-status" id="modal-status"></span>
    </div>
  </div>
  <div class="modal-task">Current: <span id="modal-task"></span></div>
  <div class="modal-completed"><strong style="color:var(--dim);font-size:10px">Recent completions:</strong><ul id="modal-completed"></ul></div>
</div>

<script src="data.js"></script>
<script>
const charIds = ['char-jarvis','char-research','char-builder','char-outreach','char-scanner'];
const charImgs = ['characters/jarvis.webp','characters/research.webp','characters/builder.webp','characters/outreach.webp','characters/scanner.webp'];

// Clock
function updateClock(){
  const now = new Date();
  document.getElementById('clock-time').textContent = now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'America/New_York'});
}
updateClock(); setInterval(updateClock,30000);

// Render
function render(){
  const d = window.MISSION_DATA; if(!d) return;
  const {completed,inProgress,upNext,learned,agents,heartbeatFeed} = d;

  document.getElementById('stat-done').textContent = completed.length;
  document.getElementById('stat-wip').textContent = inProgress.length;
  document.getElementById('stat-queue').textContent = upNext.length;
  document.getElementById('stat-learn').textContent = learned.length;

  // Timeline zones
  document.getElementById('z-count-done').textContent = completed.length;
  document.getElementById('z-count-wip').textContent = inProgress.length;
  document.getElementById('z-count-next').textContent = upNext.length;

  document.getElementById('tl-done').innerHTML = completed.map(t =>
    `<div class="tl-item" draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)"><span class="tl-node"></span><span>${t}</span></div>`
  ).join('');

  document.getElementById('tl-wip').innerHTML = inProgress.length
    ? inProgress.map(t => `<div class="tl-item" draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)"><span class="tl-node"></span><span>${t}</span></div>`).join('')
    : '<div style="color:var(--dim);font-size:10px;padding:8px;text-align:center">All clear ✨</div>';

  document.getElementById('tl-next').innerHTML = upNext.length
    ? upNext.map(t => `<div class="tl-item" draggable="true" ondragstart="dragStart(event)" ondragend="dragEnd(event)"><span class="tl-node"></span><span>${t}</span></div>`).join('')
    : '<div style="color:var(--dim);font-size:10px;padding:8px;text-align:center">—</div>';

  // Learned badges
  document.getElementById('tl-learned').innerHTML = learned.map(t =>
    `<span class="tl-badge">◆ ${t}</span>`
  ).join('');

  // Characters
  agents.forEach((a,i)=>{
    const el = document.getElementById(charIds[i]);
    if(!el) return;
    el.className = 'character '+(a.status==='working'?'char-working':'char-idle');
    const bubble = document.getElementById('bubble-'+i);
    if(bubble) bubble.textContent = a.task;
    const tag = el.querySelector('.nametag');
    if(tag) tag.style.color = a.color;
  });

  // Heartbeat feed
  renderHeartbeat(heartbeatFeed);
}

function renderHeartbeat(feed){
  const container = document.getElementById('hb-items');
  const timeEl = document.getElementById('hb-time');
  if(!feed){
    container.innerHTML = '<div class="hb-empty">Waiting for heartbeat…</div>';
    timeEl.textContent = '';
    return;
  }
  // Support both formats: object {time, items:[]} or array [{time, message}]
  if(feed.time && feed.items){
    timeEl.textContent = feed.time;
    container.innerHTML = feed.items.map((item,i) => {
      const cls = i === 0 ? 'active' : '';
      const text = typeof item === 'string' ? item : item.message || '';
      return `<div class="hb-item ${cls}"><span class="hb-marker"></span><span>${text}</span></div>`;
    }).join('');
  } else if(Array.isArray(feed) && feed.length){
    timeEl.textContent = feed[0].time || '';
    container.innerHTML = feed.map(item => {
      const cls = item.status === 'active' ? 'active' : '';
      return `<div class="hb-item ${cls}"><span class="hb-marker"></span><span>${item.message}</span></div>`;
    }).join('');
  } else {
    container.innerHTML = '<div class="hb-empty">Waiting for heartbeat…</div>';
    timeEl.textContent = '';
  }
}

render();

// Modal
function showModal(i){
  const d = window.MISSION_DATA; if(!d) return;
  const a = d.agents[i];
  document.getElementById('modal-avatar').src = charImgs[i];
  document.getElementById('modal-name').textContent = a.name;
  const st = document.getElementById('modal-status');
  st.textContent = a.status; st.className = 'modal-status '+a.status;
  document.getElementById('modal-task').textContent = a.task;
  const items = d.completed.slice(0,3);
  document.getElementById('modal-completed').innerHTML = items.map(t=>`<li>${t}</li>`).join('');
  document.getElementById('modal-overlay').classList.add('open');
  document.getElementById('char-modal').classList.add('open');
}
function closeModal(){
  document.getElementById('modal-overlay').classList.remove('open');
  document.getElementById('char-modal').classList.remove('open');
}

// Wandering
const basePositions = [
  {left:8,top:28},{left:28,top:32},{left:50,top:26},{left:70,top:30},{left:88,top:34}
];
function wander(){
  const i = Math.floor(Math.random()*5);
  const el = document.getElementById(charIds[i]);
  if(!el) return;
  const base = basePositions[i];
  const dx = (Math.random()-0.5)*6;
  const dy = (Math.random()-0.5)*4;
  const img = el.querySelector('img');
  if(dx<0) img.style.transform = 'scaleX(-1)';
  else img.style.transform = 'scaleX(1)';
  el.style.transition = 'left 3s ease-in-out, top 3s ease-in-out';
  el.style.left = (base.left+dx)+'%';
  el.style.top = (base.top+dy)+'%';
  setTimeout(()=>{
    img.style.transform = 'scaleX(1)';
    el.style.left = base.left+'%';
    el.style.top = base.top+'%';
  },4000);
}
setInterval(wander,5000);

// Task handoff
function taskHandoff(){
  const d = window.MISSION_DATA; if(!d) return;
  const from = 0;
  const to = 1+Math.floor(Math.random()*4);
  const fromEl = document.getElementById(charIds[from]);
  const toEl = document.getElementById(charIds[to]);
  if(!fromEl||!toEl) return;
  const doc = document.getElementById('handoff-doc');
  const scene = document.getElementById('scene');
  const sr = scene.getBoundingClientRect();
  const fr = fromEl.getBoundingClientRect();
  const tr = toEl.getBoundingClientRect();
  const startX = fr.left-sr.left+fr.width/2;
  const startY = fr.top-sr.top+fr.height/3;
  const endX = tr.left-sr.left+tr.width/2;
  const endY = tr.top-sr.top+tr.height/3;
  doc.style.left = startX+'px';
  doc.style.top = startY+'px';
  doc.style.opacity = '1';
  doc.style.transition = 'left 2s ease-in-out, top 2s ease-in-out';
  const bubble = document.getElementById('bubble-'+to);
  requestAnimationFrame(()=>{
    doc.style.left = endX+'px';
    doc.style.top = endY+'px';
  });
  setTimeout(()=>{
    if(bubble) bubble.classList.add('visible');
    doc.style.opacity = '0';
  },2200);
  setTimeout(()=>{
    if(bubble) bubble.classList.remove('visible');
  },5000);
}
setInterval(taskHandoff,18000);
setTimeout(taskHandoff,3000);

// Periodic speech bubbles
function flashBubble(){
  const i = Math.floor(Math.random()*5);
  const b = document.getElementById('bubble-'+i);
  if(!b) return;
  b.classList.add('visible');
  setTimeout(()=>b.classList.remove('visible'),3500);
}
setInterval(flashBubble,7000);

// Bottom panels render
function renderPanels(){
  const d = window.MISSION_DATA; if(!d) return;

  // Gateway
  const gw = d.gateway || {};
  const gwEl = document.getElementById('gw-content');
  const gwInd = document.getElementById('gw-indicator');
  const isOk = gw.rpcStatus === 'ok';
  gwInd.style.background = isOk ? 'var(--green)' : 'var(--red)';
  gwInd.style.boxShadow = isOk ? '0 0 6px rgba(107,207,127,.5)' : '0 0 6px rgba(232,93,93,.5)';
  gwEl.innerHTML = `
    <div class="gw-row"><span class="gw-dot ${isOk?'ok':'err'}"></span><span class="gw-label">RPC:</span><span class="gw-val">${gw.rpcStatus||'unknown'}</span></div>
    <div class="gw-row"><span class="gw-dot ${gw.serviceRunning?'ok':'warn'}"></span><span class="gw-label">Service:</span><span class="gw-val">${gw.serviceRunning?'running':'stopped'}</span></div>
    <div class="gw-row"><span class="gw-label">Port:</span><span class="gw-val">${gw.port||'18789'}</span></div>
    <div class="gw-row"><span class="gw-label">Bind:</span><span class="gw-val">${gw.bind||'loopback'}</span></div>
  `;

  // Skills
  const skills = d.skills || {ready:[],missing:[]};
  const skGrid = document.getElementById('sk-grid');
  const skSum = document.getElementById('sk-summary');
  const allSkills = [
    ...skills.ready.map(s => `<span class="sk-chip ready">${s}</span>`),
    ...skills.missing.slice(0,8).map(s => `<span class="sk-chip missing">${s}</span>`)
  ];
  skGrid.innerHTML = allSkills.join('');
  skSum.textContent = `${skills.ready.length} ready / ${skills.missing.length} available`;

  // Approvals
  const approvals = d.pendingApprovals || [];
  const apEl = document.getElementById('ap-content');
  if(!approvals.length){
    apEl.innerHTML = '<div class="ap-empty">No pending approvals</div>';
  } else {
    apEl.innerHTML = approvals.map((a,i) => `
      <div class="ap-item">
        <span class="ap-agent">${a.agent||'Jarvis'}</span>
        <span class="ap-text">${a.task||a}</span>
        <button class="ap-btn yes" onclick="approveTask(${i})">✓</button>
        <button class="ap-btn no" onclick="rejectTask(${i})">✕</button>
      </div>
    `).join('');
  }
}
function approveTask(i){
  const d = window.MISSION_DATA; if(!d) return;
  const task = d.pendingApprovals[i];
  d.pendingApprovals.splice(i,1);
  // Save decision to localStorage for agent to read
  const decisions = JSON.parse(localStorage.getItem('mc-approvals')||'[]');
  decisions.push({task:task.task||task, action:'approved', time:new Date().toISOString()});
  localStorage.setItem('mc-approvals', JSON.stringify(decisions));
  renderPanels();
}
function rejectTask(i){
  const d = window.MISSION_DATA; if(!d) return;
  const task = d.pendingApprovals[i];
  d.pendingApprovals.splice(i,1);
  const decisions = JSON.parse(localStorage.getItem('mc-approvals')||'[]');
  decisions.push({task:task.task||task, action:'rejected', time:new Date().toISOString()});
  localStorage.setItem('mc-approvals', JSON.stringify(decisions));
  renderPanels();
}
renderPanels();

// Audit log
function toggleAudit(){
  document.getElementById('audit-section').classList.toggle('open');
  document.getElementById('audit-toggle').classList.toggle('open');
}
function renderAudit(){
  const d = window.MISSION_DATA; if(!d || !d.heartbeatHistory) return;
  const container = document.getElementById('audit-items');
  if(!d.heartbeatHistory.length){
    container.innerHTML = '<div style="color:var(--dim);font-size:10px;padding:8px">No heartbeat history yet</div>';
    return;
  }
  container.innerHTML = d.heartbeatHistory.map(h =>
    `<div class="audit-entry">
      <div class="audit-entry-time">${h.time||''}</div>
      <div class="audit-entry-items">${(h.items||[]).map(i=>'<div>• '+i+'</div>').join('')}</div>
    </div>`
  ).join('');
}
renderAudit();

// Drag and drop
let draggedEl = null;
function dragStart(e){
  draggedEl = e.target.closest('.tl-item');
  draggedEl.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', draggedEl.querySelector('span:last-child').textContent);
}
function dragEnd(e){
  if(draggedEl) draggedEl.classList.remove('dragging');
  draggedEl = null;
  document.querySelectorAll('.tl-zone').forEach(z => z.classList.remove('drag-over'));
}
document.querySelectorAll('.tl-zone').forEach(zone => {
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    if(!draggedEl) return;
    const items = zone.querySelector('.tl-zone-items');
    if(items) items.appendChild(draggedEl);
    // Save to localStorage for persistence
    saveKanbanState();
  });
});
function saveKanbanState(){
  const state = {};
  ['tl-done','tl-wip','tl-next'].forEach(id => {
    state[id] = [...document.querySelectorAll('#'+id+' .tl-item span:last-child')].map(s=>s.textContent);
  });
  localStorage.setItem('mc-kanban', JSON.stringify(state));
}

// Auto-refresh
setInterval(()=>{
  const s = document.createElement('script');
  s.src = 'data.js?t='+Date.now();
  s.onload = ()=>{render(); renderPanels(); renderAudit(); document.head.removeChild(s);}
  document.head.appendChild(s);
},15000);
</script>
</body>
</html>
